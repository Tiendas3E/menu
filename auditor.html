
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Shop - Auditor铆a</title>
  <link rel="stylesheet" href="styles_system.css" />
  <style>
    .auditor-container {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .filter-group input, .filter-group select {
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
    }

    .audit-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #004aad;
    }

    .stat-label {
      color: #666;
      font-size: 0.9em;
    }

    .transactions-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #004aad;
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background: #f5f9ff;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 0;
    }

    .export-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <header>
    <h1> Auditor铆a del Sistema</h1>
    <nav>
      <button onclick="location.href='index.html'">Inicio</button>
      <button onclick="location.href='reports.html'">Reportes</button>
      <button onclick="logout()">Cerrar Sesi贸n</button>
    </nav>
  </header>

  <div class="auditor-container">
    <!-- Filtros -->
    <div class="filters">
      <div class="filter-group">
        <label>Fecha Desde:</label>
        <input type="date" id="dateFrom">
      </div>
      <div class="filter-group">
        <label>Fecha Hasta:</label>
        <input type="date" id="dateTo">
      </div>
      <div class="filter-group">
        <label>Tipo de Movimiento:</label>
        <select id="movementType">
          <option value="">Todos</option>
          <option value="venta">Ventas</option>
          <option value="ajuste">Ajustes</option>
          <option value="corte">Cortes</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Usuario:</label>
        <input type="text" id="userFilter" placeholder="Filtrar por usuario...">
      </div>
    </div>

    <!-- Estad铆sticas -->
    <div class="audit-stats">
      <div class="stat-card">
        <div class="stat-number" id="totalTransactions">0</div>
        <div class="stat-label">Total Transacciones</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalSales">$0</div>
        <div class="stat-label">Ventas Totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayTransactions">0</div>
        <div class="stat-label">Hoy</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="averageTicket">$0</div>
        <div class="stat-label">Ticket Promedio</div>
      </div>
    </div>

    <!-- Bot贸n Exportar -->
    <button class="export-btn" onclick="exportAuditData()"> Exportar Reporte de Auditor铆a</button>

    <!-- Tabla de Transacciones -->
    <div class="transactions-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha/Hora</th>
            <th>Tipo</th>
            <th>Usuario</th>
            <th>Productos</th>
            <th>Total</th>
            <th>M茅todo Pago</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="transactionsBody">
          <!-- Las transacciones se cargar谩n aqu铆 -->
        </tbody>
      </table>
    </div>
  </div>

  <script src="auth.js"></script>
  <script src="storage-utils.js"></script>
  <script>
    // Verificar autenticaci贸n y permisos
    if (!requireAuth() || !hasPermission('auditor')) {
      window.location.href = 'login.html';
    }

    let allTransactions = [];

    document.addEventListener('DOMContentLoaded', function() {
      loadAuditData();
      setupEventListeners();
    });

    function loadAuditData() {
      allTransactions = getTransactions();
      renderTransactions(allTransactions);
      updateStats(allTransactions);
    }

    function setupEventListeners() {
      document.getElementById('dateFrom').addEventListener('change', filterTransactions);
      document.getElementById('dateTo').addEventListener('change', filterTransactions);
      document.getElementById('movementType').addEventListener('change', filterTransactions);
      document.getElementById('userFilter').addEventListener('input', filterTransactions);
    }

    function filterTransactions() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const movementType = document.getElementById('movementType').value;
      const userFilter = document.getElementById('userFilter').value.toLowerCase();

      let filtered = allTransactions;

      // Filtrar por fecha
      if (dateFrom) {
        filtered = filtered.filter(t => new Date(t.timestamp) >= new Date(dateFrom));
      }
      if (dateTo) {
        const endDate = new Date(dateTo);
        endDate.setHours(23, 59, 59);
        filtered = filtered.filter(t => new Date(t.timestamp) <= endDate);
      }

      // Filtrar por tipo (simplificado)
      if (movementType) {
        filtered = filtered.filter(t => t.tipo === movementType);
      }

      // Filtrar por usuario
      if (userFilter) {
        filtered = filtered.filter(t => 
          t.usuario?.toLowerCase().includes(userFilter)
        );
      }

      renderTransactions(filtered);
      updateStats(filtered);
    }

    function renderTransactions(transactions) {
      const tbody = document.getElementById('transactionsBody');
      
      tbody.innerHTML = transactions.map(transaction => `
        <tr>
          <td>${transaction.id}</td>
          <td>${formatDateTime(transaction.timestamp)}</td>
          <td>${getTransactionTypeBadge(transaction.tipo)}</td>
          <td>${transaction.usuario || 'Sistema'}</td>
          <td>${transaction.items ? transaction.items.length : 0} productos</td>
          <td>$${transaction.total?.toFixed(2) || '0.00'}</td>
          <td>${transaction.metodoPago || 'N/A'}</td>
          <td><span class="badge badge-success">Completado</span></td>
        </tr>
      `).join('');
    }

    function updateStats(transactions) {
      document.getElementById('totalTransactions').textContent = transactions.length;
      
      const totalSales = transactions.reduce((sum, t) => sum + (t.total || 0), 0);
      document.getElementById('totalSales').textContent = `$${totalSales.toFixed(2)}`;
      
      const today = new Date().toDateString();
      const todayCount = transactions.filter(t => 
        new Date(t.timestamp).toDateString() === today
      ).length;
      document.getElementById('todayTransactions').textContent = todayCount;
      
      const average = transactions.length > 0 ? totalSales / transactions.length : 0;
      document.getElementById('averageTicket').textContent = `$${average.toFixed(2)}`;
    }

    function formatDateTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('es-MX');
    }

    function getTransactionTypeBadge(type) {
      const types = {
        'venta': ' Venta',
        'ajuste': '锔 Ajuste', 
        'corte': ' Corte',
        'devolucion': '╋ Devoluci贸n'
      };
      return types[type] || type || 'N/A';
    }

    function exportAuditData() {
      const filteredTransactions = getFilteredTransactions();
      const dataStr = JSON.stringify(filteredTransactions, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `auditoria_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    }

    function getFilteredTransactions() {
      // Replicar la l贸gica de filtrado actual para exportar
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const movementType = document.getElementById('movementType').value;
      const userFilter = document.getElementById('userFilter').value.toLowerCase();

      let filtered = allTransactions;

      if (dateFrom) filtered = filtered.filter(t => new Date(t.timestamp) >= new Date(dateFrom));
      if (dateTo) {
        const endDate = new Date(dateTo);
        endDate.setHours(23, 59, 59);
        filtered = filtered.filter(t => new Date(t.timestamp) <= endDate);
      }
      if (movementType) filtered = filtered.filter(t => t.tipo === movementType);
      if (userFilter) filtered = filtered.filter(t => t.usuario?.toLowerCase().includes(userFilter));

      return filtered;
    }

    function logout() {
      if (confirm('驴Est谩s seguro de que quieres cerrar sesi贸n?')) {
        logoutUser();
        window.location.href = 'login.html';
      }
    }
  </script>
</body>
</html>
